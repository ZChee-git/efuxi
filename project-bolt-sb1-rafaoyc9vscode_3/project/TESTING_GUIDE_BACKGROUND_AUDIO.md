# 息屏播放测试指南

## 测试环境准备

### 1. 部署应用
```bash
npm run build
# 或用测试服务器
npm run dev
```

### 2. 在移动设备上访问
- **Android**: 在 Chrome/Firefox 中打开应用 URL
- **iOS**: 在 Safari 中打开，然后"分享" → "添加到主屏幕"

---

## 测试场景

### 场景 1: 基本播放测试
**目标**: 验证音频播放功能完整性

#### 步骤:
1. 打开应用，点击"播放"按钮
2. 验证系统音频控制器显示
3. 验证音频播放正常

#### 预期结果:
- ✅ 能看到系统原生音频控制条
- ✅ 能看到进度条、时间显示
- ✅ 音频清晰播放，无杂音

---

### 场景 2: 息屏后台播放（核心功能）
**目标**: 验证锁屏/熄屏后音频继续播放

#### 步骤:
1. 点击"播放"按钮启动音频
2. 音频开始播放后，按电源键锁屏/熄屏
3. 保持锁屏状态 10-30 秒
4. 再按电源键解锁

#### 预期结果:
- ✅ 锁屏时音频**持续播放**（不暂停）
- ✅ 锁屏界面显示播放器控制
- ✅ 解锁后回到应用，音频继续播放

#### 故障排查:
| 问题 | 原因 | 解决 |
|------|------|------|
| 锁屏后立即暂停 | 浏览器未识别 MediaSession | 检查 Console 日志，确认 mediaSession 初始化 |
| 看不到锁屏控制 | Media Session 未配置元数据 | 刷新并重新播放 |
| 仍然暂停 | iOS 限制 | 确保应用已添加到主屏幕 |

---

### 场景 3: 锁屏控制测试
**目标**: 验证锁屏界面按钮可用

#### 步骤:
1. 启动音频播放，锁屏
2. 在锁屏界面：
   - 点击"暂停"按钮
   - 等待 3 秒
   - 点击"播放"按钮
   - 点击"下一曲"按钮
   - 点击"上一曲"按钮

#### 预期结果:
- ✅ 暂停按钮：音频暂停，按钮变为播放图标
- ✅ 播放按钮：音频继续，按钮变为暂停图标
- ✅ 下一曲：跳到下一个视频，继续播放
- ✅ 上一曲：返回前一个视频，继续播放

---

### 场景 4: 音量控制测试
**目标**: 验证系统音量键有效

#### 步骤:
1. 启动音频播放，锁屏
2. 按设备侧面音量减键
3. 验证音量降低（可在锁屏看到音量条）
4. 按音量加键
5. 验证音量提高

#### 预期结果:
- ✅ 音量按键响应灵敏
- ✅ 锁屏界面显示音量条
- ✅ 音量调节实时生效

---

### 场景 5: 应用切换测试
**目标**: 验证切换到其他应用后音频继续播放

#### 步骤:
1. 启动音频播放
2. 按 Home 键返回主屏幕
3. 打开其他应用（如浏览器、微信等）
4. 等待 10-20 秒
5. 返回学习应用
6. 验证播放位置

#### 预期结果:
- ✅ 切换应用时音频继续播放（虽然看不到，但能听到）
- ✅ 返回应用后，播放位置正确推进
- ✅ 可立即暂停/播放

---

### 场景 6: 视频模式不受影响
**目标**: 验证视频播放模式仍正常工作

#### 步骤:
1. 在一个复习周期中添加视频文件（mediaType='video'）
2. 点击"播放"按钮
3. 验证视频显示
4. 验证自定义控制器显示

#### 预期结果:
- ✅ 视频文件正常显示
- ✅ 自定义控制条显示
- ✅ 手势控制（触屏暂停等）仍可用

---

### 场景 7: 离线播放测试
**目标**: 验证已缓存的音频可离线播放

#### 步骤:
1. 在有网络下播放音频文件 3-5 次（确保缓存）
2. 启用浏览器离线模式（DevTools → Network → Offline）
3. 刷新应用
4. 尝试播放已缓存的文件

#### 预期结果:
- ✅ 已缓存文件可正常播放
- ✅ 新文件显示加载错误（可接受）
- ✅ Service Worker 成功拦截请求

---

## 浏览器 DevTools 调试

### 检查 Media Session 状态

打开 DevTools → Console：

```javascript
// 检查是否支持
console.log('MediaSession支持:', 'mediaSession' in navigator);

// 查看当前元数据
console.log('元数据:', navigator.mediaSession.metadata);

// 查看播放状态
console.log('播放状态:', navigator.mediaSession.playbackState);
```

### 检查 Service Worker 缓存

1. 打开 DevTools
2. 左侧菜单 → Application → Cache Storage
3. 查看 `ebbinghaus-video-v2` 缓存
4. 验证音频文件已缓存

### 检查音频事件日志

在 VideoPlayer.tsx 中已添加 console.log：

```
DevTools → Console
搜索 "Auto-play" 或 "Media error"
```

---

## 性能指标

### 测试项目

| 指标 | 正常值 | 告警值 |
|------|--------|--------|
| 音频缓冲时间 | < 1s | > 3s |
| 锁屏延迟 | < 100ms | > 500ms |
| 内存占用 | < 50MB | > 100MB |
| 电池消耗 | ~5% per hour | > 10% per hour |

### 如何测试

**Android**:
1. 打开 Chrome DevTools
2. 菜单 → More tools → Performance Monitor
3. 观察内存和 CPU 占用

**iOS**:
1. 设置 → Developer → GPU Recorder
2. 录制 5-10 分钟，查看性能指标

---

## 常见问题排查

### Q1: 锁屏后立即停止播放
**检查清单**:
- [ ] 确保在音频模式下（不是视频）
- [ ] 检查 audio 元素 `controls={true}`
- [ ] 查看 Console 是否有错误信息
- [ ] 尝试刷新页面重新播放
- [ ] 检查系统设置，是否禁用了后台播放

**iOS 特殊**:
- [ ] 应用是否已添加到主屏幕？
- [ ] 网络连接是否稳定？
- [ ] 是否需要授予媒体权限？

### Q2: 看不到锁屏控制
**检查清单**:
- [ ] Console 中查找 "MediaSession" 相关日志
- [ ] 确认 metadata 已设置
- [ ] 尝试播放 3 秒以上再锁屏

### Q3: 音量控制不响应
**检查清单**:
- [ ] 检查设备音量是否为最低
- [ ] 尝试在应用外测试音量键是否可用
- [ ] 检查系统静音开关状态

### Q4: 应用切换后失音
**检查清单**:
- [ ] 打开 Chrome DevTools → Application → Manifest
- [ ] 验证 PWA 配置是否正确
- [ ] 检查 Service Worker 是否激活

---

## 完整测试流程检查表

```
□ 环境准备
  □ 应用已构建或 dev 服务启动
  □ 可在手机浏览器中访问
  □ Service Worker 已注册（Console: "SW registered")

□ 基础功能
  □ 点击播放，音频正常播放
  □ 系统音频控制器可见
  □ 进度条和时间显示正确

□ 核心功能 - 息屏播放
  □ 锁屏后音频继续播放
  □ 锁屏界面显示播放器控制
  □ 解锁后应用状态一致

□ 控制功能
  □ 锁屏播放/暂停按钮可用
  □ 锁屏下一曲/上一曲按钮可用
  □ 音量按键响应

□ 多应用场景
  □ 切换其他应用，音频继续播放
  □ 返回应用，播放进度正确

□ 视频模式
  □ 视频文件显示和播放正常
  □ 自定义控制器仍可见
  □ 不受音频模式改动影响

□ 离线/缓存
  □ 已缓存音频可离线播放
  □ Service Worker 缓存策略有效

□ 性能
  □ 无明显卡顿或延迟
  □ 内存占用正常
  □ 电池消耗在可接受范围

```

---

## 提交反馈

如发现问题，请提供：
1. 设备型号和系统版本
2. 浏览器名称和版本
3. 具体步骤重现问题
4. Console 错误日志（如有）
5. 预期结果 vs 实际结果
